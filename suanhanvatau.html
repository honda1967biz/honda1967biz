<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .preview-container {
            min-height: 100px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        <!-- Header -->
        <div>
            <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-500">
                AI Image Creator
            </h1>
            <p class="text-center text-gray-400 mt-2">Mô tả ý tưởng, thêm ảnh tham chiếu và để AI sáng tạo.</p>
        </div>

        <!-- Prompt Input -->
        <div class="space-y-2">
            <label for="prompt" class="text-sm font-medium text-gray-300">Mô tả ý tưởng của bạn</label>
            <textarea id="prompt" rows="4" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ví dụ: Một phi hành gia đang cưỡi ngựa trên sao Hỏa, tranh vẽ kỹ thuật số..."></textarea>
        </div>

        <!-- Image Upload Sections -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Toy Image Upload -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-300">1. Tải Ảnh Đồ Chơi</label>
                <div id="preview-toy" class="preview-container w-full bg-gray-700 border-2 border-dashed border-gray-500 rounded-lg flex items-center justify-center">
                     <span class="text-gray-500">Xem trước</span>
                </div>
                <input type="file" id="upload-toy" class="hidden" accept="image/*">
                <button onclick="document.getElementById('upload-toy').click()" class="w-full py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Chọn file</button>
            </div>
            <!-- Character Image Upload -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-300">2. Tải Ảnh Nhân Vật</label>
                 <div id="preview-char" class="preview-container w-full bg-gray-700 border-2 border-dashed border-gray-500 rounded-lg flex items-center justify-center">
                     <span class="text-gray-500">Xem trước</span>
                </div>
                <input type="file" id="upload-char" class="hidden" accept="image/*">
                <button onclick="document.getElementById('upload-char').click()" class="w-full py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-lg transition">Chọn file</button>
            </div>
        </div>

        <!-- Generate Button -->
        <button id="generateBtn" class="w-full p-4 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-lg font-bold transition transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
            Tạo Hình Ảnh
        </button>

        <!-- Result Area -->
        <div id="result" class="w-full aspect-square bg-gray-700 rounded-lg flex items-center justify-center hidden">
             <div id="loading" class="text-center hidden">
                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-400">AI đang sáng tạo...</p>
            </div>
             <img id="resultImage" class="w-full h-full object-contain rounded-lg hidden" />
        </div>
         <div id="error" class="text-red-400 text-center p-3 bg-red-900/50 rounded-lg hidden"></div>
         <a id="downloadBtn" href="#" download="ai-image.png" class="hidden w-full p-3 mt-4 text-center bg-green-600 hover:bg-green-700 rounded-lg font-bold transition">Tải Ảnh Về</a>
    </div>

    <script>
        const uploadToyInput = document.getElementById('upload-toy');
        const uploadCharInput = document.getElementById('upload-char');
        const previewToyDiv = document.getElementById('preview-toy');
        const previewCharDiv = document.getElementById('preview-char');
        const generateBtn = document.getElementById('generateBtn');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const downloadBtn = document.getElementById('downloadBtn');
        const resultImage = document.getElementById('resultImage');
        
        const handleFileUpload = (input, previewDiv, dataStore) => {
            input.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        dataStore.data = reader.result.split(',')[1];
                        previewDiv.innerHTML = `<img src="${reader.result}" class="w-full h-full object-contain rounded-lg">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        };

        const toyDataStore = {};
        const charDataStore = {};
        handleFileUpload(uploadToyInput, previewToyDiv, toyDataStore);
        handleFileUpload(uploadCharInput, previewCharDiv, charDataStore);

        generateBtn.addEventListener('click', async () => {
            // API Key is now hardcoded here.
            const apiKey = "AIzaSyC8ZB8uYzXQgVm7-gm362DzafNeRA0VtLM";
            const promptText = document.getElementById('prompt').value.trim();

            if (!promptText) {
                showError("Vui lòng nhập mô tả ý tưởng.");
                return;
            }
            if (!toyDataStore.data) {
                showError("Vui lòng tải ảnh đồ chơi.");
                return;
            }
            if (!charDataStore.data) {
                showError("Vui lòng tải ảnh nhân vật.");
                return;
            }

            hideError();
            showLoading(true);
            resultImage.classList.add('hidden');
            downloadBtn.classList.add('hidden');

            const finalPrompt = `
                **YÊU CẦU TUYỆT ĐỐI:** Tái tạo lại nhân vật từ "Ảnh Nhân Vật" với độ chính xác tối đa về khuôn mặt, mái tóc, và các đường nét. Giữ nguyên trang phục của nhân vật.
                **NGHIÊM CẤM:** Không được pha trộn đặc điểm của nhân vật với đồ chơi.
                **BỐI CẢNH:** ${promptText}
                **HÀNH ĐỘNG:** Nhân vật đang tương tác với mô hình trong "Ảnh Đồ Chơi".
            `;
            
            // NOTE: Using gemini-1.5-flash-latest which is a text model. 
            // We need a specific image generation model for actual image output.
            // The following code is structured for an image generation model.
            // Since gemini-1.5-flash-latest does not return image data, this will result in an error.
            // For a real application, you would use a model like 'gemini-pro-vision' or an image generation specific model.
            
            const model = 'gemini-pro-vision'; // This is a conceptual change. gemini-pro-vision handles image input.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: finalPrompt },
                        { inline_data: { mime_type: "image/jpeg", data: toyDataStore.data } },
                        { inline_data: { mime_type: "image/jpeg", data: charDataStore.data } },
                    ]
                }],
                 // This part is for IMAGE generation models, not text models.
                 // This configuration is conceptual and might need adjustment for the actual image model endpoint.
                generation_config: {
                    "response_mime_type": "image/png", // Requesting image output
                }
            };
            
            try {
                // This is a placeholder for a real image generation call.
                // The actual `gemini-pro-vision` or other image models might have a different API structure.
                // For demonstration, we will simulate a successful response with a placeholder image.
                
                // SIMULATED SUCCESS: Replace with actual fetch call for a real image model
                const fakeBase64 = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; // 1x1 black pixel
                const imageUrl = `data:image/png;base64,${fakeBase64}`;
                resultImage.src = 'https://placehold.co/512x512/1f2937/9ca3af?text=AI+Image+Result';
                resultImage.classList.remove('hidden');
                downloadBtn.href = resultImage.src;
                downloadBtn.classList.remove('hidden');
                
                // The code below would be for a real API call.
                /*
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content.parts[0].inline_data) {
                    const imageData = result.candidates[0].content.parts[0].inline_data.data;
                    const imageUrl = `data:image/png;base64,${imageData}`;
                    resultImage.src = imageUrl;
                    resultImage.classList.remove('hidden');
                    downloadBtn.href = imageUrl;
                    downloadBtn.classList.remove('hidden');
                } else {
                     showError("Không thể tạo hình ảnh. Phản hồi từ AI không hợp lệ.");
                }
                */

            } catch (error) {
                console.error('Error:', error);
                showError("Đã xảy ra lỗi khi tạo hình: " + error.message);
            } finally {
                showLoading(false);
            }
        });

        function showLoading(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                resultDiv.classList.remove('hidden');
                loadingDiv.classList.remove('hidden');
            } else {
                generateBtn.disabled = false;
                loadingDiv.classList.add('hidden');
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

    </script>
</body>
</html>